#!/bin/sh
REGISTRY=$1
ENVIRONMENT=$2
ECR_ENDPOINT=${REGISTRY}/${ECR_REPOSITORY}

deploy_branch() {
# Set the deployment host, this will add the prefix of the branch name e.g el-257-deploy-with-circleci or just main
  IDENTIFIER="$RELEASE_NAME-$K8S_NAMESPACE-green"
  echo "Release Host is: $RELEASE_HOST"
  echo "Deploying CIRCLE_SHA1: $CIRCLE_SHA1 under release name: '$RELEASE_NAME'..."
  echo "Identifier: $IDENTIFIER..."
  echo "ECR_ENDPOINT: $ECR_ENDPOINT..."
  echo "IMAGE_TAG: $IMAGE_TAG..."

  helm upgrade ${RELEASE_NAME} \
                ./helm_deploy/. \
                --install --wait \
                --namespace=${K8S_NAMESPACE} \
                --values ./helm_deploy/values-${ENVIRONMENT}.yaml \
                --set fullnameOverride=$RELEASE_NAME \
                --set environment=$RELEASE_NAME \
                --set image.repository="${ECR_ENDPOINT}" \
                --set image.tag="${IMAGE_TAG}" \
                --set ingress.cluster.name=green \
                --set ingress.cluster.weight=100 \
                --set ingress.hosts[0].host="$RELEASE_HOST" \
                --debug \
                --atomic
}

deploy_main() {
  helm upgrade laa-claim-non-standard-magistrate-fee-backend \
                        ./helm_deploy/. \
                          --install --wait \
                          --namespace=${K8S_NAMESPACE} \
                          --values ./helm_deploy/values-${ENVIRONMENT}.yaml \
                          --set image.repository="${ECR_ENDPOINT}" \
                          --set ingress.cluster.name=green \
                          --set ingress.cluster.weight=100 \
                          --set image.tag="${IMAGE_TAG}" \
                          --debug \
                          --atomic
}

if [[ "$CIRCLE_BRANCH" == "main" ]]; then
  deploy_main
else
  deploy_branch
fi




