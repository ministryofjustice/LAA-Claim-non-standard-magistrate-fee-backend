#!/bin/sh
REGISTRY=$1
ENVIRONMENT=$2
# Convert the branch name into a string that can be turned into a valid URL
  BRANCH_RELEASE_NAME=$(echo $CIRCLE_BRANCH | tr '[:upper:]' '[:lower:]' | sed 's:^\w*\/::' | tr -s ' _/[]().' '-' | cut -c1-18 | sed 's/-$//')
  ECR_ENDPOINT=${REGISTRY}/${ECR_REPOSITORY}

deploy_branch() {
# Set the deployment host, this will add the prefix of the branch name e.g el-257-deploy-with-circleci or just main
  RELEASE_HOST="${BRANCH_RELEASE_NAME}-${HOST}"
  IDENTIFIER="$BRANCH_RELEASE_NAME-laa-claim-non-standard-magistrate-fee-$K8S_NAMESPACE-green"
  echo "Release Host is: $RELEASE_HOST"
  echo "Deploying CIRCLE_SHA1: $CIRCLE_SHA1 under release name: '$BRANCH_RELEASE_NAME'..."
  echo "Identifier: $IDENTIFIER..."
  echo "ECR_ENDPOINT: $ECR_ENDPOINT..."

#  helm upgrade $BRANCH_RELEASE_NAME ./helm_deploy/. \
#                --install --wait \
#                --namespace=${K8S_NAMESPACE} \
#                --values ./helm_deploy/values-${ENVIRONMENT}.yaml \
#                --set image.repository="${ECR_ENDPOINT}" \
#                --set image.tag="branch-$CIRCLE_SHA1" \
#                --set ingress.annotations."external-dns\.alpha\.kubernetes\.io/set-identifier"="$IDENTIFIER" \
#                --set ingress.hosts[0].host="$RELEASE_HOST" \
#                --debug \
#                --atomic
}

deploy_main() {
  helm upgrade laa-claim-non-standard-magistrate-fee-backend ./helm_deploy/. \
                          --install --wait \
                          --namespace=${K8S_NAMESPACE} \
                          --values ./helm_deploy/values-${ENVIRONMENT}.yaml \
                          --set image.repository="${ECR_ENDPOINT}" \
                          --set image.tag="main-$CIRCLE_SHA1"
}

if [[ "$CIRCLE_BRANCH" == "main" ]]; then
  deploy_main
else
  deploy_branch
#  if [ $? -eq 0 ]; then
#    echo "Deploy succeeded"
#  else
#    # If a previous `helm upgrade` was cancelled this could have got the release stuck in
#    # a "pending-upgrade" state (c.f. https://stackoverflow.com/a/65135726). If so, this
#    # can generally be fixed with a `helm rollback`, so we try that here.
#    echo "Deploy failed. Attempting rollback"
#    helm rollback $BRANCH_RELEASE_NAME
#    if [ $? -eq 0 ]; then
#      echo "Rollback succeeded. Retrying deploy"
#      deploy_branch
#    else
#      echo "Rollback failed. Consider manually running 'helm delete $BRANCH_RELEASE_NAME'"
#      exit 1
#    fi
#  fi
fi



